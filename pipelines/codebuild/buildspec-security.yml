version: 0.2

env:
  variables:
    DOTNET_ROOT: /root/.dotnet
    PATH: /root/.dotnet:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin

phases:
  install:
    commands:
      - echo "Installing .NET 10 SDK for SBOM publish..."
      - curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
      - chmod +x dotnet-install.sh
      - ./dotnet-install.sh --channel 10.0 --quality daily --install-dir /root/.dotnet
      - ln -sf /root/.dotnet/dotnet /usr/local/bin/dotnet
      - dotnet --info | head -n 20
      - echo "Ensuring pip is available..."
      - curl -sSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
      - python3 get-pip.py
  pre_build:
    commands:
      - echo "Installing security scanning tools..."
      - python3 -m pip install --upgrade pip
      - python3 -m pip install semgrep bandit
      - echo "Installing SBOM generation tool..."
      - npm install -g @cyclonedx/bom

  build:
    commands:
      - echo "Running Semgrep static analysis..."
      - semgrep --config=p/security-audit --json src/claim-status-api/ > semgrep-results.json || true
      
      - echo "Running Bandit for Python security (if any)..."
      - bandit -r src/ -f json > bandit-results.json || true
      
      - echo "Generating SBOM..."
      - dotnet publish src/claim-status-api/claim-status-api.csproj --configuration Release --output ./publish
      - cyclonedx-dotnet publish/claim-status-api.dll --output-file sbom.xml || true
      
      - echo "Scanning container image layers..."
      - echo "Image:" '$REGISTRY/$REPOSITORY:$IMAGE_TAG'
      - echo "Checking for vulnerable dependencies in packages..."

  post_build:
    commands:
      - echo "Security scan completed"


artifacts:
  files:
    - 'semgrep-results.json'
    - 'bandit-results.json'
    - 'sbom.xml'
  name: SecurityArtifact

reports:
  SemgrepReport:
    files:
      - 'semgrep-results.json'
    file-format: 'JSON'
  SBOMReport:
    files:
      - 'sbom.xml'
    file-format: 'XML'
