name: .NET Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'introspect2B.sln'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'introspect2B.sln'

jobs:
  test:
    name: Run unit tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore introspect2B.sln

      - name: Test with coverage
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: |
          set -euo pipefail
          mkdir -p test-results
          dotnet test introspect2B.sln -v minimal --collect:"XPlat Code Coverage" --results-directory test-results

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate HTML coverage report
        run: |
          set -euo pipefail
          export PATH="$PATH:$HOME/.dotnet/tools"
          mkdir -p test-results/coverage-html
          # Find all cobertura files produced by XPlat Code Coverage
          REPORTS=$(ls -1 test-results/**/coverage.cobertura.xml 2>/dev/null | paste -sd ';' -)
          if [ -z "$REPORTS" ]; then
            echo "No coverage.cobertura.xml files found under test-results" >&2
            exit 1
          fi
          # Exclude generated and obj files to avoid missing-source issues from source generators
          reportgenerator \
            -reports:"$REPORTS" \
            -targetdir:test-results/coverage-html \
            -reporttypes:Html \
            -filefilters:-*.generated.cs

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-test-results
          path: test-results

      - name: Summarize
        if: always()
        run: |
          {
            echo "### .NET Tests"
            echo "- Solution: introspect2B.sln"
            echo "- Coverage: Cobertura XML + HTML (see artifacts)"
            echo "- HTML Report: test-results/coverage-html/index.html"
            echo
            echo "#### Re-run locally"
            echo "dotnet restore introspect2B.sln"
            echo "dotnet test introspect2B.sln -v minimal --collect:\"XPlat Code Coverage\" --results-directory test-results"
            echo "dotnet tool install -g dotnet-reportgenerator-globaltool"
            echo "reportgenerator -reports:\"test-results/**/coverage.cobertura.xml\" -targetdir:test-results/coverage-html -reporttypes:Html \"-filefilters:-*.generated.cs;-**/Program.*\""
          } >> "$GITHUB_STEP_SUMMARY"
