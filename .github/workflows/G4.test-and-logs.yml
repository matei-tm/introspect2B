name: 4. Test and Collect Logs

on:
  workflow_dispatch:
  workflow_call:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: materclaims-cluster
  NAMESPACE: materclaims
  DEPLOYMENT_NAME: claim-status-api
  CLOUDWATCH_NAMESPACE: amazon-cloudwatch
  LAMBDA_FUNCTION: materclaims-cluster-intelligent-autoscaler

jobs:
  test-and-logs:
    name: Test Deployment and Collect Logs
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Verify cluster access
        run: |
          echo "## ðŸ” Cluster Information" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl cluster-info | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check deployment status
        id: deployment
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get deployments -n ${{ env.NAMESPACE }} -o wide | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check if deployment is ready
          READY=$(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.readyReplicas}')
          DESIRED=$(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.replicas}')
          
          if [ "$READY" = "$DESIRED" ]; then
            echo "âœ… Deployment ready: $READY/$DESIRED pods" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Deployment not fully ready: $READY/$DESIRED pods" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check pod status
        id: pods
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Pod Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Resource Usage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl top pods -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY || echo "Metrics not available yet" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Test API health endpoint
        id: api-health
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¥ API Health Check" >> $GITHUB_STEP_SUMMARY
          
          # Get LoadBalancer URL
          LB_URL=$(kubectl get service ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -n "$LB_URL" ]; then
            echo "LoadBalancer URL: http://$LB_URL" | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\nResponse Time: %{time_total}s\n" "http://$LB_URL/health" | tee -a $GITHUB_STEP_SUMMARY || echo "Health endpoint not responding" | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ LoadBalancer not ready yet" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check Bedrock integration logs
        id: bedrock-logs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¤– Bedrock Integration Logs" >> $GITHUB_STEP_SUMMARY
          echo "Searching for Bedrock invocations in application logs..." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} --tail=100 | grep -i "bedrock\|invoke\|claude" | tail -20 | tee -a $GITHUB_STEP_SUMMARY || echo "No Bedrock logs found in recent activity" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Bedrock CloudWatch metrics
        id: bedrock-metrics
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Bedrock Metrics (Last 10 Minutes)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Calculate timestamps using epoch time (more portable)
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d "10 minutes ago" +%Y-%m-%dT%H:%M:%S 2>/dev/null || date -u -v-10M +%Y-%m-%dT%H:%M:%S)
          
          # Get Bedrock inference duration metrics
          BEDROCK_METRICS=$(aws cloudwatch get-metric-statistics \
            --namespace ClaimStatusAPI \
            --metric-name BedrockInferenceDuration \
            --dimensions Name=Service,Value=claim-status-api Name=Model,Value=claude-3-haiku \
            --start-time "$START_TIME" \
            --end-time "$END_TIME" \
            --period 300 \
            --statistics Average,Maximum,SampleCount \
            --query 'Datapoints[*].[Timestamp,Average,Maximum,SampleCount]' \
            --output text 2>&1)
          
          if [ -n "$BEDROCK_METRICS" ] && [ "$BEDROCK_METRICS" != "None" ] && ! echo "$BEDROCK_METRICS" | grep -q "An error occurred"; then
            echo "$BEDROCK_METRICS" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "No Bedrock metrics available in the last 10 minutes" | tee -a $GITHUB_STEP_SUMMARY
            echo "This is normal if no API calls with Bedrock were made recently" | tee -a $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check intelligent autoscaler logs
        id: autoscaler-logs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§  Intelligent Autoscaler Activity" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Get recent Lambda execution logs
          aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION }} \
            --since 10m \
            --format short \
            --filter-pattern '{ $.decision.action = * }' 2>&1 | head -50 | tee -a $GITHUB_STEP_SUMMARY || echo "No recent autoscaler activity" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bedrock-Related Scaling Decisions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws logs filter-log-events \
            --log-group-name /aws/lambda/${{ env.LAMBDA_FUNCTION }} \
            --start-time $(($(date +%s) - 600))000 \
            --filter-pattern 'Bedrock' \
            --query 'events[*].message' \
            --output text 2>&1 | head -20 | tee -a $GITHUB_STEP_SUMMARY || echo "No Bedrock-related scaling decisions" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Container Insights status
        id: container-insights
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Container Insights Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.CLOUDWATCH_NAMESPACE }} -o wide | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Insights Log Groups" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws logs describe-log-groups \
            --log-group-name-prefix "/aws/containerinsights/${{ env.EKS_CLUSTER_NAME }}" \
            --query 'logGroups[*].[logGroupName,storedBytes]' \
            --output table | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Collect application logs
        id: app-logs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Application Logs (Last 50 Lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} --tail=50 | tee -a $GITHUB_STEP_SUMMARY || echo "No logs available" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Collect CloudWatch agent logs
        id: cw-agent-logs
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š CloudWatch Agent Logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n ${{ env.CLOUDWATCH_NAMESPACE }} daemonset/cloudwatch-agent --tail=20 | tee -a $GITHUB_STEP_SUMMARY || echo "CloudWatch agent logs not available" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate comprehensive logs deliverable
        run: |
          mkdir -p logs
          TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
          
          {
            echo "# Claim Status API - Test Results and Logs"
            echo ""
            echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "**Cluster:** ${{ env.EKS_CLUSTER_NAME }}"
            echo "**Region:** ${{ env.AWS_REGION }}"
            echo "**Deployment:** ${{ env.DEPLOYMENT_NAME }}"
            echo ""
            
            echo "## ðŸ“Š Deployment Status"
            echo '```'
            kubectl get deployments,services -n ${{ env.NAMESPACE }} -o wide
            echo '```'
            echo ""
            
            echo "## ðŸ“¦ Pod Status"
            echo '```'
            kubectl get pods -n ${{ env.NAMESPACE }} -o wide
            kubectl describe pods -n ${{ env.NAMESPACE }} 2>&1 | head -100
            echo '```'
            echo ""
            
            echo "## ðŸ¤– Bedrock Integration Analysis"
            echo '```'
            echo "=== Application Logs (Bedrock mentions) ==="
            kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} --tail=200 | grep -i "bedrock\|invoke\|claude" || echo "No Bedrock activity found"
            echo ""
            echo "=== CloudWatch Bedrock Metrics (Last 1 Hour) ==="
            # Calculate timestamps
            END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
            START_TIME=$(date -u -d "1 hour ago" +%Y-%m-%dT%H:%M:%S 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%S)
            aws cloudwatch get-metric-statistics \
              --namespace ClaimStatusAPI \
              --metric-name BedrockInferenceDuration \
              --dimensions Name=Service,Value=claim-status-api Name=Model,Value=claude-3-haiku \
              --start-time "$START_TIME" \
              --end-time "$END_TIME" \
              --period 300 \
              --statistics Average,Maximum,Minimum,SampleCount \
              --output table 2>&1 || echo "No Bedrock metrics available"
            echo '```'
            echo ""
            
            echo "## ðŸ§  Intelligent Autoscaler Activity"
            echo '```'
            echo "=== Lambda Function Status ==="
            aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION }} --query 'Configuration.[FunctionName,LastModified,State]' --output table
            echo ""
            echo "=== Recent Executions (Last 30 Minutes) ==="
            aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION }} --since 30m --format short 2>&1 | head -100
            echo ""
            echo "=== Scaling Decisions (Non-None Actions) ==="
            aws logs filter-log-events \
              --log-group-name /aws/lambda/${{ env.LAMBDA_FUNCTION }} \
              --start-time $(($(date +%s) - 1800))000 \
              --filter-pattern '{ $.decision.action != "none" }' \
              --query 'events[*].message' \
              --output text 2>&1 | head -50
            echo '```'
            echo ""
            
            echo "## ðŸ“Š CloudWatch Container Insights"
            echo '```'
            kubectl get pods -n ${{ env.CLOUDWATCH_NAMESPACE }}
            echo ""
            echo "=== Log Groups ==="
            aws logs describe-log-groups \
              --log-group-name-prefix "/aws/containerinsights/${{ env.EKS_CLUSTER_NAME }}" \
              --query 'logGroups[*].[logGroupName,storedBytes]' \
              --output table
            echo ""
            echo "=== Recent Container Insights Logs ==="
            aws logs tail "/aws/containerinsights/${{ env.EKS_CLUSTER_NAME }}/application" \
              --since 10m --format short 2>&1 | head -50 || echo "No recent logs"
            echo '```'
            echo ""
            
            echo "## ðŸ“ Full Application Logs"
            echo '```'
            kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} --tail=200 || echo "No logs available"
            echo '```'
            echo ""
            
            echo "## ðŸ”§ Troubleshooting Commands"
            echo '```bash'
            echo "# Update kubeconfig"
            echo "aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}"
            echo ""
            echo "# Check deployment status"
            echo "kubectl get deployments,pods,services -n ${{ env.NAMESPACE }} -o wide"
            echo ""
            echo "# Follow application logs in real-time"
            echo "kubectl logs -f -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }}"
            echo ""
            echo "# Check for Bedrock invocations"
            echo "kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} | grep -i bedrock"
            echo ""
            echo "# View Lambda autoscaler logs"
            echo "aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION }} --follow"
            echo ""
            echo "# Check Bedrock metrics"
            echo "aws cloudwatch get-metric-statistics \\"
            echo "  --namespace ClaimStatusAPI \\"
            echo "  --metric-name BedrockInferenceDuration \\"
            echo "  --dimensions Name=Service,Value=claim-status-api \\"
            echo "  --start-time \$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \\"
            echo "  --end-time \$(date -u +%Y-%m-%dT%H:%M:%S) \\"
            echo "  --period 300 --statistics Average,Maximum"
            echo ""
            echo "# Test API endpoint"
            echo "LB_URL=\$(kubectl get service ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')"
            echo "curl http://\$LB_URL/health"
            echo '```'
          } > logs/test-results-${TIMESTAMP}.md

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30

      - name: Test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Test and Log Collection Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Logs artifact:** \`test-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Findings" >> $GITHUB_STEP_SUMMARY
          
          # Check deployment health
          READY=$(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          DESIRED=$(kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
          
          if [ "$READY" = "$DESIRED" ] && [ "$READY" != "0" ]; then
            echo "- âœ… Deployment healthy: $READY/$DESIRED pods ready" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Deployment issues: $READY/$DESIRED pods ready" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check Container Insights
          CI_PODS=$(kubectl get pods -n ${{ env.CLOUDWATCH_NAMESPACE }} --no-headers 2>/dev/null | wc -l)
          echo "- ðŸ“Š Container Insights: $CI_PODS pods running" >> $GITHUB_STEP_SUMMARY
          
          # Check Lambda
          LAMBDA_STATE=$(aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION }} --query 'Configuration.State' --output text 2>/dev/null || echo "Unknown")
          echo "- ðŸ§  Intelligent Autoscaler: $LAMBDA_STATE" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Access" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# View application logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} --tail=50" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check Bedrock activity" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n ${{ env.NAMESPACE }} deployment/${{ env.DEPLOYMENT_NAME }} | grep -i bedrock" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View autoscaler decisions" >> $GITHUB_STEP_SUMMARY
          echo "aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION }} --since 10m" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
