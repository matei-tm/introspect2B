name: 1.3 Deploy AWS CodePipeline

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region to deploy to
        required: true
        default: us-east-1
        type: string
      stack_name:
        description: CloudFormation stack name
        required: true
        default: introspect2b-codepipeline-v2
        type: string
      parameter_overrides:
        description: Optional CloudFormation parameter overrides (key=value ...)
        required: false
        type: string


permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy CodePipeline
    runs-on: ubuntu-latest
    env:
      TEMPLATE_FILE: pipelines/codepipeline/pipeline.yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve inputs
        id: resolve
        shell: bash
        env:
          DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          DEFAULT_STACK: ${{ vars.CF_STACK_NAME }}
          DEFAULT_PARAMS: ${{ vars.CF_PARAMETER_OVERRIDES }}
          GITHUB_PAT: ${{ secrets.CODEPIPELINE_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REGION="${{ github.event.inputs.aws_region }}"
          STACK="${{ github.event.inputs.stack_name }}"
          PARAMS="${{ github.event.inputs.parameter_overrides }}"
          REGION="${REGION:-${DEFAULT_REGION:-us-east-1}}"
          STACK="${STACK:-${DEFAULT_STACK:-introspect2b-codepipeline-v2}}"
          PARAMS="${PARAMS:-${DEFAULT_PARAMS:-}}"
          # Append GitHubToken from secret by default, if provided and not already present
          if [[ -n "${GITHUB_PAT}" && "${PARAMS}" != *"GitHubToken="* ]]; then
            if [[ -n "${PARAMS}" ]]; then
              PARAMS+=" "
            fi
            PARAMS+="GitHubToken=${GITHUB_PAT}"
          fi
          echo "region=$REGION" >> "$GITHUB_OUTPUT"
          echo "stack=$STACK" >> "$GITHUB_OUTPUT"
          echo "params=$PARAMS" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.resolve.outputs.region }}


      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template --template-body file://${{ env.TEMPLATE_FILE }}

      - name: Deploy CloudFormation stack
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${{ steps.resolve.outputs.stack }}"
          PARAMS="${{ steps.resolve.outputs.params }}"
          CMD=(aws cloudformation deploy \
            --stack-name "$STACK_NAME" \
            --template-file "${{ env.TEMPLATE_FILE }}" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset)
          if [[ -n "$PARAMS" ]]; then
            # shellcheck disable=SC2206
            CMD+=(--parameter-overrides $PARAMS)
          fi
          # Avoid printing full command to reduce secret exposure in logs
          echo "Running CloudFormation deploy for stack: $STACK_NAME"
          "${CMD[@]}"

      - name: Show CloudFormation failure events
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${{ steps.resolve.outputs.stack }}"
          echo "Deployment failed. Fetching CloudFormation events for: $STACK_NAME"
          aws cloudformation describe-stack-events --stack-name "$STACK_NAME" --output table || true
          echo "Current stack status:"
          aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
            --query "[Stacks[0].StackStatus, Stacks[0].StackStatusReason]" --output text || true

      - name: Show stack outputs
        run: |
          aws cloudformation describe-stacks --stack-name "${{ steps.resolve.outputs.stack }}" \
            --query "Stacks[0].Outputs" --output table || true
