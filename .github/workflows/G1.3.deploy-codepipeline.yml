name: 1.3 Deploy AWS CodePipeline

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region to deploy to
        required: true
        default: us-east-1
        type: string
      stack_name:
        description: CloudFormation stack name
        required: true
        default: introspect2b-codepipeline-v2
        type: string
      perf_stack_name:
        description: CloudFormation stack name for the performance pipeline
        required: true
        default: introspect2b-codepipeline-perf
        type: string
      parameter_overrides:
        description: Optional CloudFormation parameter overrides (key=value ...)
        required: false
        type: string
  workflow_call:
    inputs:
      aws_region:
        description: AWS region to deploy to
        required: false
        default: us-east-1
        type: string
      stack_name:
        description: CloudFormation stack name
        required: false
        default: introspect2b-codepipeline-v2
        type: string
      perf_stack_name:
        description: CloudFormation stack name for the performance pipeline
        required: false
        default: introspect2b-codepipeline-perf
        type: string
      parameter_overrides:
        description: Optional CloudFormation parameter overrides (key=value ...)
        required: false
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_SESSION_TOKEN:
        required: false
      CODEPIPELINE_GITHUB_TOKEN:
        required: false


permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy CodePipeline
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/deploy-codepipeline
        with:
          aws_region: ${{ github.event.inputs.aws_region || inputs.aws_region || secrets.AWS_REGION || 'us-east-1' }}
          stack_name: ${{ github.event.inputs.stack_name || inputs.stack_name || vars.CF_STACK_NAME || 'introspect2b-codepipeline-v2' }}
          perf_stack_name: ${{ github.event.inputs.perf_stack_name || inputs.perf_stack_name || vars.CF_PERF_STACK_NAME || 'introspect2b-codepipeline-perf' }}
          parameter_overrides: ${{ github.event.inputs.parameter_overrides || inputs.parameter_overrides || vars.CF_PARAMETER_OVERRIDES || '' }}
          github_pat: ${{ secrets.CODEPIPELINE_GITHUB_TOKEN }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_session_token: ${{ secrets.AWS_SESSION_TOKEN }}
