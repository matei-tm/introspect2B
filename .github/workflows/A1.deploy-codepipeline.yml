name: A1.Deploy AWS CodePipeline

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region to deploy to
        required: true
        default: us-east-1
        type: string
      stack_name:
        description: CloudFormation stack name
        required: true
        default: introspect2b-codepipeline
        type: string
      parameter_overrides:
        description: Optional CloudFormation parameter overrides (key=value ...)
        required: false
        type: string


permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy CodePipeline
    runs-on: ubuntu-latest
    env:
      TEMPLATE_FILE: pipelines/codepipeline/pipeline.yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve inputs
        id: resolve
        shell: bash
        env:
          DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          DEFAULT_STACK: ${{ vars.CF_STACK_NAME }}
          DEFAULT_PARAMS: ${{ vars.CF_PARAMETER_OVERRIDES }}
        run: |
          set -euo pipefail
          REGION="${{ github.event.inputs.aws_region }}"
          STACK="${{ github.event.inputs.stack_name }}"
          PARAMS="${{ github.event.inputs.parameter_overrides }}"
          REGION="${REGION:-${DEFAULT_REGION:-us-east-1}}"
          STACK="${STACK:-${DEFAULT_STACK:-introspect2b-codepipeline}}"
          PARAMS="${PARAMS:-${DEFAULT_PARAMS:-}}"
          echo "region=$REGION" >> "$GITHUB_OUTPUT"
          echo "stack=$STACK" >> "$GITHUB_OUTPUT"
          echo "params=$PARAMS" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials (OIDC role)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ steps.resolve.outputs.region }}

      - name: Configure AWS credentials (Access Keys)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.resolve.outputs.region }}

      - name: Fail if no AWS credentials configured
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' && (secrets.AWS_ACCESS_KEY_ID == '' || secrets.AWS_SECRET_ACCESS_KEY == '') }}
        run: |
          echo "Missing AWS credentials. Set secret 'AWS_ROLE_TO_ASSUME' for OIDC or provide 'AWS_ACCESS_KEY_ID' + 'AWS_SECRET_ACCESS_KEY'." >&2
          exit 1

      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template --template-body file://${{ env.TEMPLATE_FILE }}

      - name: Deploy CloudFormation stack
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${{ steps.resolve.outputs.stack }}"
          PARAMS="${{ steps.resolve.outputs.params }}"
          CMD=(aws cloudformation deploy \
            --stack-name "$STACK_NAME" \
            --template-file "${{ env.TEMPLATE_FILE }}" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset)
          if [[ -n "$PARAMS" ]]; then
            # shellcheck disable=SC2206
            CMD+=(--parameter-overrides $PARAMS)
          fi
          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Show stack outputs
        run: |
          aws cloudformation describe-stacks --stack-name "${{ steps.resolve.outputs.stack }}" \
            --query "Stacks[0].Outputs" --output table || true
