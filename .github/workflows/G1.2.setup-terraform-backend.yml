name: 1.2 Setup Terraform Backend

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS region for backend resources'
        required: false
        default: 'us-east-1'
        type: string

env:
  AWS_REGION: ${{ github.event.inputs.aws_region || 'us-east-1' }}

jobs:
  setup-backend:
    name: Create S3 Backend Resources
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $ACCOUNT_ID"

      - name: Check if backend already exists
        id: check
        run: |
          BUCKET_NAME="introspect2b-terraform-state-${{ steps.account.outputs.account_id }}"
          
          if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ S3 bucket $BUCKET_NAME already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… S3 bucket $BUCKET_NAME does not exist, will create"
          fi
          
          if aws dynamodb describe-table --table-name introspect2b-terraform-locks --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "dynamodb_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ DynamoDB table introspect2b-terraform-locks already exists"
          else
            echo "dynamodb_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… DynamoDB table does not exist, will create"
          fi

      - name: Run backend setup script
        if: steps.check.outputs.exists == 'false' || steps.check.outputs.dynamodb_exists == 'false'
        working-directory: iac/terraform
        run: |
          chmod +x backend-setup.sh
          ./backend-setup.sh ${{ env.AWS_REGION }}

      - name: Verify backend resources
        run: |
          BUCKET_NAME="introspect2b-terraform-state-${{ steps.account.outputs.account_id }}"
          
          echo "### ðŸ—‚ï¸ S3 Bucket Configuration" >> $GITHUB_STEP_SUMMARY
          aws s3api get-bucket-versioning --bucket "$BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”’ DynamoDB Table Status" >> $GITHUB_STEP_SUMMARY
          aws dynamodb describe-table --table-name introspect2b-terraform-locks --region ${{ env.AWS_REGION }} \
            --query 'Table.[TableName,TableStatus,BillingModeSummary.BillingMode]' --output table >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate backend configuration
        run: |
          BUCKET_NAME="introspect2b-terraform-state-${{ steps.account.outputs.account_id }}"
          
          echo "## âœ… Terraform Backend Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Update \`iac/terraform/main.tf\` with:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```hcl' >> $GITHUB_STEP_SUMMARY
          echo 'terraform {' >> $GITHUB_STEP_SUMMARY
          echo '  backend "s3" {' >> $GITHUB_STEP_SUMMARY
          echo "    bucket         = \"$BUCKET_NAME\"" >> $GITHUB_STEP_SUMMARY
          echo '    key            = "terraform.tfstate"' >> $GITHUB_STEP_SUMMARY
          echo "    region         = \"${{ env.AWS_REGION }}\"" >> $GITHUB_STEP_SUMMARY
          echo '    dynamodb_table = "introspect2b-terraform-locks"' >> $GITHUB_STEP_SUMMARY
          echo '    encrypt        = true' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Update the backend configuration in \`iac/terraform/main.tf\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`terraform init -migrate-state\` to migrate local state (if exists)" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the **2. Deploy Terraform Infrastructure** workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **S3 Bucket**: \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Versioning: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "  - Encryption: AES256" >> $GITHUB_STEP_SUMMARY
          echo "  - Public Access: Blocked" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **DynamoDB Table**: \`introspect2b-terraform-locks\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "  - Billing: Pay-per-request" >> $GITHUB_STEP_SUMMARY

      - name: Save configuration to artifact
        run: |
          BUCKET_NAME="introspect2b-terraform-state-${{ steps.account.outputs.account_id }}"
          cat > backend-config.txt <<EOF
          # Terraform Backend Configuration
          # Generated: $(date)
          # AWS Account: ${{ steps.account.outputs.account_id }}
          # Region: ${{ env.AWS_REGION }}
          
          terraform {
            backend "s3" {
              bucket         = "$BUCKET_NAME"
              key            = "terraform.tfstate"
              region         = "${{ env.AWS_REGION }}"
              dynamodb_table = "introspect2b-terraform-locks"
              encrypt        = true
            }
          }
          EOF
          cat backend-config.txt

      - name: Upload backend configuration
        uses: actions/upload-artifact@v4
        with:
          name: terraform-backend-config
          path: backend-config.txt
          retention-days: 30
